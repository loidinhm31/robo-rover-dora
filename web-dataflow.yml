nodes:
  - id: audio-capture
    build: cargo build --release -p audio_capture
    path: target/release/audio_capture
    inputs:
      tick: dora/timer/millis/50  # 20 Hz (~50ms audio chunks)
      audio_control: web-bridge/audio_command
    outputs:
      - audio  # Float32 audio data with metadata (sample_rate, channels, format)
    env:
      SAMPLE_RATE: "16000"  # Hz (default: 16000)
      CHANNELS: "1"  # Mono (default: 1)
      CHUNK_SIZE: "800"  # Samples per chunk - 50ms at 16kHz (default: 800)

  # GStreamer camera capture (outputs raw RGB8 frames)
  - id: gst-camera
#    git: https://github.com/kornia/dora-nodes-hub.git
#    rev: 5b309b6c6f95074f8d38f2a236142e2e0751ee19
    build: cargo build -p kornia_capture --release
    path: target/release/kornia_capture
    inputs:
      tick: dora/timer/millis/33  # ~30 FPS
      camera_control: web-bridge/camera_command
    outputs:
      - frame  # Raw RGB8 frames with metadata
    env:
      # Local webcam source
      SOURCE_TYPE: "webcam"
      SOURCE_URI: "/dev/video0" # Device index (0 = default camera)
      IMAGE_COLS: "640"
      IMAGE_ROWS: "480"
      SOURCE_FPS: "30"

  # Object detector - YOLOv12n inference
  - id: object-detector
    build: cargo build --release -p object_detector
    path: target/release/object_detector
    inputs:
      frame: gst-camera/frame
    outputs:
      - detections  # DetectionFrame with bounding boxes, classes, confidence scores
    env:
      RUST_LOG: info
      MODEL_PATH: "models/yolo12n.onnx"
      CONFIDENCE_THRESHOLD: "0.5"
      NMS_THRESHOLD: "0.4"
      TARGET_CLASSES: ""  # Optional: "person,dog,cat" or leave empty for all classes
      ORT_DYLIB_PATH: "/usr/local/lib/libonnxruntime.so"

  # Object tracker - SORT algorithm with Kalman filter
  - id: object-tracker
    build: cargo build --release -p object_tracker
    path: target/release/object_tracker
    inputs:
      detections: object-detector/detections
      tracking_command: web-bridge/tracking_command
    outputs:
      - tracked_detections  # DetectionFrame with tracking IDs assigned
      - tracking_telemetry  # Current tracking state and selected target
    env:
      RUST_LOG: info
      MAX_TRACKING_AGE: "30"  # Max frames to keep lost tracks
      MIN_HITS: "3"  # Min detections before track is confirmed
      IOU_THRESHOLD: "0.3"  # Intersection over union threshold for matching



  # Web bridge with binary streaming
  - id: web-bridge
    build: cargo build --release -p web_bridge
    path: target/release/web_bridge
    inputs:
      audio_frame: audio-capture/audio
      video_frame: gst-camera/frame
      detections: object-detector/detections
      tracked_detections: object-tracker/tracked_detections
      tracking_telemetry: object-tracker/tracking_telemetry
      rover_telemetry: sim-interface/rover_telemetry
      arm_telemetry: sim-interface/arm_telemetry
    outputs:
      - arm_command
      - rover_command
      - camera_command
      - audio_command
      - tracking_command
    env:
      RUST_LOG: info
      SOCKETIO_PORT: 3030
      AUTH_USERNAME: "admin"
      AUTH_PASSWORD: "password"

  # Arm controller
  - id: arm-controller
    build: cargo build --release -p arm_controller
    path: target/release/arm_controller
    inputs:
      arm_command: web-bridge/arm_command
      arm_telemetry: sim-interface/arm_telemetry
    outputs:
      - processed_arm_command
    env:
      RUST_LOG: info
      ARM_CONFIG: config/arm_6dof.toml

  # Rover controller
  - id: rover-controller
    build: cargo build --release -p rover_controller
    path: target/release/rover_controller
    inputs:
      rover_command: web-bridge/rover_command
      servo_command: visual-servo-controller/servo_command
      rover_telemetry: sim-interface/rover_telemetry
    outputs:
      - processed_rover_command
    env:
      RUST_LOG: info

  # Simulation interface
  - id: sim-interface
    build: cargo build --release -p sim_interface
    path: target/release/sim_interface
    inputs:
      arm_command: arm-controller/processed_arm_command
      rover_command: rover-controller/processed_rover_command
    outputs:
      - rover_telemetry
      - arm_telemetry
    env:
      RUST_LOG: info